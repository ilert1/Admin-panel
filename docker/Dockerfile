# build
FROM node:18.18.2-alpine as build

WORKDIR /app

ARG VITE_API_URL
ARG VITE_APIGATE_BASE_URL
ARG VITE_BF_MANAGER_URL
ARG VITE_BANK_TRANSFER_ENABLED
ARG VITE_ENIGMA_URL
ARG VITE_KEYCLOAK_URL
ARG VITE_KEYCLOAK_LOGIN_URL
ARG VITE_KEYCLOAK_REALM
ARG VITE_KEYCLOAK_CLIENT_ID
ARG VITE_MONEYGATE_URL
ARG VITE_TEST_POPUP
ARG VITE_WALLET_URL
ARG VITE_TRANS_PROVIDER_FILTER_ENABLED

ENV NODE_OPTIONS=--openssl-legacy-provider
ENV VITE_API_URL=${VITE_API_URL}
ENV VITE_APIGATE_BASE_URL=${VITE_APIGATE_BASE_URL}
ENV VITE_BF_MANAGER_URL=${VITE_BF_MANAGER_URL}
ENV VITE_BANK_TRANSFER_ENABLED=${VITE_BANK_TRANSFER_ENABLED}
ENV VITE_ENIGMA_URL=${VITE_ENIGMA_URL}
ENV VITE_KEYCLOAK_URL=${VITE_KEYCLOAK_URL}
ENV VITE_KEYCLOAK_LOGIN_URL=${VITE_KEYCLOAK_LOGIN_URL}
ENV VITE_KEYCLOAK_REALM=${VITE_KEYCLOAK_REALM}
ENV VITE_KEYCLOAK_CLIENT_ID=${VITE_KEYCLOAK_CLIENT_ID}
ENV VITE_MONEYGATE_URL=${VITE_MONEYGATE_URL}
ENV VITE_TEST_POPUP=${VITE_TEST_POPUP}
ENV VITE_WALLET_URL=${VITE_WALLET_URL}
ENV VITE_TRANS_PROVIDER_FILTER_ENABLED=${VITE_TRANS_PROVIDER_FILTER_ENABLED}


COPY ./source/package*.json ./
RUN npm ci --prefer-offline --no-audit --progress=false

COPY ./source ./

RUN npm run build


# deploy
FROM nginx:1.26-alpine

RUN set -eux \
    && apk --no-cache add tzdata bash \
    && rm -rf /var/cache/apk/*

ENV TZ=Europe/Moscow

COPY ./docker/nginx.conf /etc/nginx/conf.d/default.conf

COPY --from=build /app/dist /usr/share/nginx/html

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
